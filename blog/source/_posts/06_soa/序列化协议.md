在开始本文之前，有一些基本的概念需要了解。

[各种序列化有什么区别](http://tech.meituan.com/serialization_vs_deserialization.html)

# 1 基本概念

## 1.1 RPC

从RPC开始，RPC（Remote Procedure Call Protocol）——远程过程调用协议，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的协议。RPC协议假定某些传输协议的存在，如TCP或UDP，为通信程序之间携带信息数据。在OSI网络通信模型中，RPC跨越了传输层和应用层。RPC使得开发包括网络分布式多程序在内的应用程序更加容易。

## 1.2 Thrift

Thrift起初用于支持Facebook后台各系统间的大量通信，以及内部多个系统语言环境不同导致通信需要跨平台跨语言的特性，逐渐演化为一个强调统一编程接口的多语言通讯框架。之所以称为框架，是因为其对通信和协议进行了封装，用户只要基于框架提供的接口回调即可非常方便地使用。其设计理念认为不存在完美的方案来解决所有问题，所以框架设计特征尽量保持中性（Neutral）。

Thrift支持多种类型的RPC服务，适用于程序间**静态的数据交换**。通信的数据结构是完全静态化的，需要事前确定，当数据结构发生变化时，必须重新进行一轮从编辑IDL文件开始，进行代码生成，再编译载入的全流程。动态性较差的另外一面是在内部数据传输方面相对于JSON和XML无论在性能、传输大小上有明显的优势。

Thrift提供了多种序列化的实现，包括压缩二进制序列化协议和缺省简单二进制序列化协议。Thrift的数据存储的时候是每个Field前面都是带Tag的，这个Tag用于标识这个域的类型和顺序ID（IDL中定义，用于Versioning）。在同一批数据里面，这些Tag的信息是完全相同的，当数据条数大的时候有一定浪费。
 
Thrift还有一个设计限制，就是客户端和服务器端需要在同一个数据中心内，也有应用开发人员使用Thrift来进行一个机器内的进程间通信而获得不错的效果。如果跨越广域网，客户端和服务器端在不同的位置，那么在信息安全、异步调用方面会面临较大的挑战，比如服务端在防火墙内，客户端在防火墙外，“server-per-service”限制需要开放特别多的端口，可能会给系统运行和维护的团队带来困扰。

## 1.3 Avro

Avro出自Hadoop之父Doug Cutting。针对Thrift需预先知道要提供服务接口细节的限制，Apache avro增加了一种新的方法——可以用Avro-generic方式支持动态加载schema的，用通用的map结构代表数据对象，从而不需要编译加载直接就可以处理新的数据源，能够在运行期动态地改变服务接口。Avro内部Schema是显式的，可以把IDL格式的Schema转化成JSON格式，用JSON格式的文件表示。这样融合了显式、declarative的Schema和高效二进制的数据表达，强调数据的自我描述，克服了以往单纯XML或二进制系统的局限，支持 Hadoop家族中Hive/Pig及其它NOSQL 等同时追求性能和灵活性的应用需求。
 
与Thrift没有强制规定序列化格式相比，Avro制定了序列化的协议，即无论是文件存储还是网络传输，数据的Schema都出现在数据的前面。数据本身并不包含任何Metadata(Tag)。在文件储存的时候，schema出现在文件头中。在网络传输的时候Schema出现在初始的握手阶段。从而使数据能够自我描述，提高数据的透明度和可操作性，还减少了数据本身的冗余信息，提高了存储效率。这种实现为应用提供了优化的便利。可以对数据作Projection，通过扫描schema只对感兴趣的部分作反序列化。支持schema的versioning和mapping，不同的版本的Reader和Writer可以通过查询schema相互交换数据(schema的aliases支持mapping)，这比Thrift采用的给每个域编号的方法要灵活。Avro的Schema允许定义数据的排序并在序列化的时候遵循这个顺序。这样话不需要反序列化就可以直接对数据进行排序。另外一个Avro的特性是采用block链表结构，突破了用单一整型表示大小的限制。比如Array或Map由一系列Block组成，每个Block包含计数器和对应的元素，计数器为0标识结束。
 
对于数据结构的改变，应用开发者往往希望不能版本的应用程序能够支持处理不同版本应用程序生成的数据。Avro采用了一种方法，当应用程序期望处理的字段不存在时，Avro提供一个schema定义的缺省值。同时，Avro忽略数据中存在但是不期望的值。这种方法不能处理所有的不同版本兼容问题，但是能够使得大多数情况得到简化。

## 1.4 Protobuf

Protobuf是Google于2008年开源的一个产品。其设计目标主要是为了解决方便为传输的数据结构引入新字段，以及数据结构格式可以自描述这两个后台分布系统间通信的难题。设计思路是支持用类似于XML，JSON这样的数据表示语言来进行序列化，为此，引入提供类似于IDL的描述语言——proto，支持通过自动代码生成来进行编码和解码等协议解析工作。序列化基于二进制格式，因此处理上更高效，传输和存储时较为节省。同样，Protobuf也为多种语言提供了binding，使分布式程序的开发可以不局限于用某一种语言来编写。不过，开源版本Protobuf的service仅仅停留在接口层，其底层的通讯，还需要用户实现，尚不能称之为一个完整的RPC框架。